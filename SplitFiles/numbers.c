#include <stdio.h>
#include <stdlib.h>
#include <arch/zx.h>
#include <stdbool.h>

#include "numbers.h"
#include "util.h"

/* Decalations for numbers code that doesn't need to be shared */

struct pairStruct {
    int x;
    int y;
};

typedef struct pairStruct pair;

const char oneData[] = {
 0x0, 0x0,
 0xf, 0xc0,
 0x1f, 0xc0,
 0x13, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0x3, 0xc0,
 0xf, 0xf0,
 0x0, 0x0
};

const char twoData[] = {
 0x0, 0x0,
 0x1f, 0xc0,
 0x1f, 0xc0,
 0x30, 0xc0,
 0x30, 0xc0,
 0x30, 0xc0,
 0x0, 0xc0,
 0x1, 0xc0,
 0x3, 0x80,
 0x7, 0x0,
 0xe, 0x0,
 0x1c, 0x0,
 0x30, 0x0,
 0x3f, 0xc0,
 0x3f, 0xc0,
 0x0, 0x0
};

const char threeData[] = {
 0x0, 0x0,
 0x7, 0x80,
 0x1f, 0xf0,
 0x1c, 0x38,
 0x0, 0x38,
 0x0, 0x70,
 0x1, 0xc0,
 0x3, 0x80,
 0x0, 0xf0,
 0x0, 0x70,
 0x0, 0x70,
 0x0, 0x70,
 0x10, 0x70,
 0x1f, 0xc0,
 0x1f, 0xc0,
 0x0, 0x0,
};

const char fourData[] = {
 0x0, 0x0,
 0x7f, 0xf0,
 0x7f, 0xf0,
 0x7f, 0xf0,
 0x70, 0x70,
 0x70, 0x70,
 0x70, 0x70,
 0x70, 0x70,
 0x70, 0x70,
 0x70, 0x70,
 0x7f, 0xfe,
 0x7f, 0xfe,
 0x7f, 0xfe,
 0x0, 0x70,
 0x0, 0x70,
 0x0, 0x0
};

const char fiveData[] = {
 0x0, 0x0,
 0x1f, 0xf8,
 0x1f, 0xf8,
 0x18, 0x0,
 0x18, 0x0,
 0x1f, 0xe0,
 0xf, 0xf0,
 0x0, 0x18,
 0x0, 0x18,
 0x0, 0x18,
 0x0, 0x18,
 0x0, 0x18,
 0x18, 0x18,
 0x1f, 0xf8,
 0x1f, 0xf0,
 0x0, 0x0
};

const char sixData[] = {
 0x0, 0x0,
 0x1f, 0xf0,
 0x1f, 0xf8,
 0x18, 0x0,
 0x18, 0x0,
 0x18, 0x0,
 0x1f, 0xf8,
 0x1f, 0xf8,
 0x18, 0x18,
 0x18, 0x18,
 0x18, 0x18,
 0x18, 0x18,
 0x18, 0x18,
 0x1f, 0xf8,
 0x1f, 0xf8,
 0x0, 0x0
};

const char sevenData[] = {
 0x0, 0x0,
 0x1f, 0xf0,
 0x1f, 0xf0,
 0x0, 0x30,
 0x0, 0x30,
 0x0, 0x60,
 0x0, 0xc0,
 0x1f, 0xf0,
 0x1f, 0xf0,
 0x3, 0x0,
 0x7, 0x0,
 0xe, 0x0,
 0x18, 0x0,
 0x18, 0x0,
 0x18, 0x0,
 0x0, 0x0
};

const char eightData[] = {
 0x0, 0x0,
 0xf, 0xf8,
 0xf, 0xf8,
 0xc, 0x18,
 0xc, 0x18,
 0xc, 0x18,
 0x6, 0x30,
 0x3, 0xe0,
 0x3, 0xe0,
 0x6, 0x30,
 0xc, 0x18,
 0xc, 0x18,
 0xc, 0x18,
 0xf, 0xf8,
 0xf, 0xf8,
 0x0, 0x0
};

const char nineData[] = {
 0x0, 0x0,
 0x1f, 0xe0,
 0x3f, 0xf0,
 0x30, 0x30,
 0x30, 0x70,
 0x38, 0x70,
 0x1f, 0xf0,
 0x7, 0xb0,
 0x0, 0x30,
 0x0, 0x30,
 0x30, 0x30,
 0x30, 0x30,
 0x33, 0xe0,
 0x3f, 0xe0,
 0xe, 0x0,
 0x0, 0x0
};

const char minusData[] = {
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x1f, 0xf8,
 0x1f, 0xf8,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0,
 0x0, 0x0
};

const char zeroData[] = {
 0x0, 0x0,
 0x1f, 0x78,
 0x38, 0x1c,
 0x60, 0xe,
 0x60, 0x16,
 0x40, 0x22,
 0x40, 0x42,
 0x0, 0x82,
 0x41, 0x0,
 0x42, 0x2,
 0x44, 0x2,
 0x68, 0x6,
 0x70, 0x6,
 0x38, 0x1c,
 0x1e, 0xf8,
 0x0, 0x0
};

pair* screenBlank(pair* st);

pair* draw_number(pair* pairIn, const char* pix) 
{
    int px = (pairIn->x) * 8;
    int py = (pairIn->y) * 8;
    char* leftPtr = zx_pxy2saddr(px, py);
    for (int j = 0; j < 2; ++j) {
        for (int i = 0; i < 8; ++i) {
            *(leftPtr) = *pix++;
            *(leftPtr + 1) = *pix++;
            leftPtr += 256;
        }
        if (j == 0) {
            leftPtr = zx_pxy2saddr(px, py + 8);
        }
    }
    pairIn->x += 2;
    return pairIn;
}

#define BUFFERLEN 7

void screenTime(const unsigned int x, const unsigned int y, const int hour, const int min)
{
    pair here = {x - 1, y - 1};
    if (hour < 10) {
        draw_number(&here, zeroData);
    }
    switch (hour) {
        case 7:
            draw_number(&here, sevenData);
            break;
        case 8:
            draw_number(&here, eightData);
            break;
        case 9:
            draw_number(&here, nineData);
            break;
        case 10:
            draw_number(&here, oneData);
            draw_number(&here, zeroData);
            break;
        default:
            draw_number(&here, oneData);
            draw_number(&here, oneData);
    }

    draw_number(&here, minusData);

    switch (min) {
        case 0:
            draw_number(&here, zeroData);
            draw_number(&here, zeroData);
            break;
        case 15:
            draw_number(&here, oneData);
            draw_number(&here, fiveData);
            break;
        case 30:
            draw_number(&here, threeData);
            draw_number(&here, zeroData);
            break;
        default:
            draw_number(&here, fourData);
            draw_number(&here, fiveData);
    }
}

void screenNumber(const unsigned int x, const unsigned int y, int numberIn)
{
    char buffer[BUFFERLEN];
    int i;
    int correction;
    int numLength;
    pair here = {x - 1, y - 1};
    itoa(numberIn, buffer, 10);
    for (numLength = 0; numLength < BUFFERLEN; numLength++) {
        if (buffer[numLength] == '\0') {
            break;
        }
    }
    correction = (BUFFERLEN - 1) - numLength;
    for (i = 0; i < correction; i++) {
        //blank out leading spaces
        screenBlank(&here);
    }
    for (i = 0; i < numLength; i++) {
        switch(buffer[i]) {
            case '0':
                draw_number(&here, zeroData);
                break;
            case '1':
                draw_number(&here, oneData);
                break;
            case '2':
                draw_number(&here, twoData);
                break;
            case '3':
                draw_number(&here, threeData);
                break;
            case '4':
                draw_number(&here, fourData);
                break;
            case '5':
               draw_number(&here, fiveData);
                break;
            case '6':
                draw_number(&here, sixData);
                break;
            case '7':
                draw_number(&here, sevenData);
                break;
            case '8':
                draw_number(&here, eightData);
                break;
            case '9':
                draw_number(&here, nineData);
                break;
            case '-':
                draw_number(&here, minusData);
                break;
            default:
                // we are done
                i = BUFFERLEN;
                break;
        }
    }
}

pair* screenBlank(pair* pairIn)
{
    int i;
    int x = pairIn->x;
    int px = x * 8;
    int y = pairIn->y;
    int py = y * 8;
    for (i = 0; i < 16; i++) {
        *zx_pxy2saddr(px + 8, py) = 0x0;
        *zx_pxy2saddr(px, py++) = 0x0;
    }
    pairIn->x = x + 2;
    return pairIn;
}
